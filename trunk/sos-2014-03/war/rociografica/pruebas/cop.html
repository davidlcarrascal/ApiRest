<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
      	
        <link href="../css/jquery-ui-1.8.22.custom.css" rel="stylesheet" type="text/css">
        <link href="../css/style_def.css" rel="stylesheet" type="text/css">
    	<script type="text/javascript" src="../js/jquery-1.9.1.min.js"></script>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>Analysis Towns</title>
   
    <link  href="../css/jqx.base.css" rel="stylesheet" type="text/css" /> 
    <script type="text/javascript" src="../js/jqxcore.js"></script>
    <script type="text/javascript" src="../js/jqxmenu.js"></script>
    <script type="text/javascript" src="../js/jqxcheckbox.js"></script>
    <script type="text/javascript" src="../js/gettheme.js"></script>
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
  </head>
  <body style="font-family: Arial;border: 0 none;">
  <div id='content'>
        <script type="text/javascript">
            $(document).ready(function () {
                var theme = getDemoTheme();
                $("#jqxMenu").jqxMenu({ width: '100%', height: '30px', theme: theme });
            
                var centerItems = function () {
                    var firstItem = $($("#jqxMenu ul:first").children()[0]);
                    firstItem.css('margin-left', 0);
                    var width = 0;
                    var borderOffset = 2;
                    $.each($("#jqxMenu ul:first").children(), function () {
                        width += $(this).outerWidth(true) + borderOffset;
                    });
                    var menuWidth = $("#jqxMenu").outerWidth();
                    firstItem.css('margin-left', (menuWidth / 2 ) - (width / 2));
                }
                centerItems();
                $(window).resize(function () {
                    centerItems();
                });
            });
        </script>

   		 </div>
  <div id ="visualTowns" class="wrapper">
    <div id="visualization" style="float:left; border-radius:15px;"></div>
    	
     <div id="seleccion_comparativa" style="float:right; width: 400px;"> 
    	<br /><br />
    	<label for="numero_analisis"> Seleccione el número de pueblos que desea comparar: </label>
    	<select id="numero_analisis">
	    	<option value="0">0</option>
	    	<option value="1">1</option>
	    	<option value="2">2</option>
	    	<option value="3">3</option>
	    	<option value="4">4</option>
	    	<option value="5">5</option>
	    	<option value="6">6</option>
	    	<option value="7">7</option>
	    	<option value="8">8</option>
	    	<option value="9">9</option>
	    	<option value="10">10</option>
    	</select>
    	
    	<div id="pueblo_1"> </div>
    	<div id="pueblo_2"> </div>
    	<div id="pueblo_3"> </div>
    	<div id="pueblo_4"> </div>
    	<div id="pueblo_5"> </div>
    	<div id="pueblo_6"> </div>
    	<div id="pueblo_7"> </div>
    	<div id="pueblo_8"> </div>
    	<div id="pueblo_9"> </div>
    	<div id="pueblo_10"> </div>
    	<div id="boton_comparar"></br><button id="comparar" class='botones'>Comparar</button></div>
   	 </div>
    </div>
    
 		<script type="text/javascript">
	        $(document).ready(function(){			
	      		//Pintar los selects con los towns
				$('#numero_analisis').on('change', function(){
					var n = $('#numero_analisis').val();
					if(n==0){
						alert("Debe visualizar al menos un pueblo");
					}else{
						//Borramos los selects
						for (var i=1; i<11; i++) {
						  $('#pueblo_'+i).text('');
						};
						
						var peticion = $.ajax({
							url:"../api/v1/towns/",
							type: 'GET'});
						peticion.done(function(data,status,jqXHR){
							var pueblos = $.parseJSON(data);
							var nom;
							var optionsPueblos;
							for (var i=0; i < pueblos.length; i++) {
							  nom = pueblos[i].nombre;
							  optionsPueblos += '<option value="'+nom+'">'+nom+'</option>';
							};
							var s = '<select>'+optionsPueblos+'</select>';
							for (var i=1; i<=n; i++) {
							  	$('#pueblo_'+i).append('</br>Pueblo '+ i +': '+s);						  
							};
							
						}); //Fin done
					}		//Fin del else							
				});//Fin del change
	        }); //fin ready	
	        
	        google.load('visualization', '1', {packages: ['corechart']});
	   	 	google.setOnLoadCallback(drawVisualization);	
				$('#comparar').on('click', function(){
					var n = $('#numero_analisis').val();
					var fin = parseInt(n)+parseInt(1);		
					if(n==0){
						alert("Debe seleccionar al menos un pueblo");
					}else{ 						
						var arrayDatos=[['Año'],['2012'],['2011'],['2010'],['2009']];
						var v9,v10,v11,v12,vehiculosantes,indice09,indice10,indice11,indice12,aux;
						
						for(var z=1; z<fin; z++){
							aux = $('#pueblo_'+z+' select').val();
							arrayDatos[0].push(aux);
						}
						
						var fila0 = arrayDatos[0];						
						var s=fila0.length;
						for(var i=1; i<s; i++){
							var peticion = $.ajax({url:"../api/v1/towns/"+ fila0[i],
									type: 'GET'});
							peticion.done(function(data,status,jqXHR) {
				    			var p1=$.parseJSON(data);
				    			//Cálculos:
				    			vehiculosantes = p1.numtotalvehiculos - p1.matriculados2012 - p1.matriculados2011 - p1.matriculados2010 - p1.matriculados2009;
								v9 = vehiculosantes + p1.matriculados2009;
								v10 = v9 + p1.matriculados2010;
								v11 = v10 + p1.matriculados2011;												
								indice09 = p1.matriculados2009 * 100 / v9;
								indice09 = (indice09).toFixed(2);
								indice10 = p1.matriculados2010 * 100 / v10;
								indice10 = (indice10).toFixed(2);
								indice11 = p1.matriculados2011 * 100 / v11;
								indice11 = (indice11).toFixed(2);								
								indice12 = p1.matriculados2012 * 100 / p1.numtotalvehiculos;
								indice12 = (indice12).toFixed(2);

				    			//Guardamos los datos en la última posición de cada fila
				    			arrayDatos[1].push(parseFloat(indice12));
				    			arrayDatos[2].push(parseFloat(indice11));
				    			arrayDatos[3].push(parseFloat(indice10));
				    			arrayDatos[4].push(parseFloat(indice09));	
				    			
				    			drawVisualization(arrayDatos);
							});					
															
						} //fin for
					}//fin del else
				});	  //fin click  	     
       
function drawVisualization(datos) {
    // Create and populate the data table.
    var data = google.visualization.arrayToDataTable(datos);
    // Create and draw the visualization.
    var options = {title:"% vehículos matriculados por año",
    		backgroundColor: '#CCC',
            width:600, height:500,
            vAxis: {title: "Años"},
            hAxis: {title: "%"}};
  	new google.visualization.BarChart(document.getElementById('visualization')).draw(data,options);
  }     
        </script>
  </body>
</html>